version: 2.1

parameters:
  # This parameter is used to trigger the main workflow
  trigger:
    type: boolean
    default: true

  # A parameter per package
  color_client:
    type: boolean
    default: false
  color_server:
    type: boolean
    default: false

executors:
  go:
    docker:
      - image: golang:1.13.4
        environment:
          GO111MODULE: "on"

jobs:
  trigger-workflows:
    executor: go
    steps:
      - checkout
      - run:
          name: Trigger workflows
          command: chmod +x scripts/ci_trigger.sh && scripts/ci_trigger.sh

  build:
    parameters:
      service_name:
        type: string
    executor: go
    working_directory: ~/project/services/<< parameters.service_name >>
    steps:
      - checkout
      - run: make build SERVICE_NAME=<< parameters.service_name >>

#  deploy:
#    parameters:
#      package_name:
#        type: string
#
#    executor: node
#    working_directory: ~/project/packages/<< parameters.service_name >>
#
#    steps:
#      - attach_workspace:
#          at: ~/project
#      # This step is added to show that files are available from the build job.
#      - run:
#          name: Content to deploy
#          command: ls && cat build.txt
#      - deploy:
#          name: Deploy
#          command: echo "Deploying << parameters.service_name >> ..."

workflows:
  version: 2

  # The main workflow responsible for triggering all other workflows
  # in which changes are detected.
  ci:
    when: << pipeline.parameters.trigger >>
    jobs:
      - trigger-workflows


  # Workflows defined for each package.

  color_client:
    when: << pipeline.parameters.color_client >>
    jobs:
      - build:
          name: client-build
          service_name: color_client
      - deploy:
          name: client-deploy
          service_name: color_client
          requires:
            - client-build

  color_server:
    when: << pipeline.parameters.color_server >>
    jobs:
      - build:
          name: server-build
          service_name: color_server
      - deploy:
          name: server-deploy
          service_name: color_server
          requires:
            - server-build